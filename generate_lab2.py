import nbformat as nbf
import os

nb = nbf.v4.new_notebook()

# ===== –Ø–ß–ï–ô–ö–ê 1: –ó–ê–ì–û–õ–û–í–û–ö =====
md1 = """# üìä –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ2: DFT/FFT –∏ —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
**–ö—É—Ä—Å:** –û—Å–Ω–æ–≤—ã —Ç–µ–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å–∏—Å—Ç–µ–º (–û–¢–°–∏–°)  
**–¶–µ–ª—å:** –û—Å–≤–æ–∏—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ, —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏.

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
1. –ß—Ç–æ —Ç–∞–∫–æ–µ DFT (–¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ)?
2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç FFT (–±—ã—Å—Ç—Ä–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ)?
3. –ö–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–µ–∫—Ç—Ä?
4. –ß—Ç–æ —Ç–∞–∫–æ–µ —É—Ç–µ—á–∫–∞ —Å–ø–µ–∫—Ç—Ä–∞ –∏ –∫–∞–∫ –µ—ë –∏–∑–±–µ–∂–∞—Ç—å?"""

# ===== –Ø–ß–ï–ô–ö–ê 2: –ò–ú–ü–û–†–¢–´ =====
code_imports = """import numpy as np
import matplotlib.pyplot as plt
from scipy import signal
from scipy.fft import fft, fftfreq, ifft

plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (12, 6)
print('‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!')"""

# ===== –Ø–ß–ï–ô–ö–ê 3: –¢–ï–û–†–ò–Ø DFT =====
md2 = """## 1. –î–∏—Å–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –§—É—Ä—å–µ (DFT)

DFT –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Å–∏–≥–Ω–∞–ª –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤ —á–∞—Å—Ç–æ—Ç–Ω—É—é:

$$X[k] = \\sum_{n=0}^{N-1} x[n] e^{-j2\\pi kn/N}$$

–ì–¥–µ:
- $x[n]$ ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª (N –æ—Ç—Å—á–µ—Ç–æ–≤)
- $X[k]$ ‚Äî —Å–ø–µ–∫—Ç—Ä (N –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π)
- $k$ ‚Äî –Ω–æ–º–µ—Ä —á–∞—Å—Ç–æ—Ç–Ω–æ–≥–æ –±–∏–Ω–∞ (0 –¥–æ N-1)

**–í–∞–∂–Ω–æ:** –°–ø–µ–∫—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–º–ø–ª–∏—Ç—É–¥–µ –ò —Ñ–∞–∑–µ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–æ—Ç–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

### –ê–º–ø–ª–∏—Ç—É–¥–Ω—ã–π —Å–ø–µ–∫—Ç—Ä:
$$|X[k]| = \\sqrt{\\text{Real}^2 + \\text{Imag}^2}$$

### –§–∞–∑–æ–≤—ã–π —Å–ø–µ–∫—Ç—Ä:
$$\\angle X[k] = \\arctan\\left(\\frac{\\text{Imag}}{\\text{Real}}\\right)$$"""

# ===== –Ø–ß–ï–ô–ö–ê 4: –ë–ê–ó–û–í–´–ô –ü–†–ò–ú–ï–† =====
code_basic = """# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
fs = 1000  # –ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏
t = np.arange(0, 1.0, 1/fs)  # 1 —Å–µ–∫—É–Ω–¥–∞

# –°–∏–≥–Ω–∞–ª: –º–∏–∫—Å –∏–∑ 3 —á–∞—Å—Ç–æ—Ç
f1, f2, f3 = 10, 25, 50  # –ì–µ—Ä—Ü—ã
s = np.sin(2*np.pi*f1*t) + 0.5*np.sin(2*np.pi*f2*t) + 0.3*np.sin(2*np.pi*f3*t)

# DFT (FFT –≤ Python)
N = len(s)
S = fft(s)  # –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Å–ø–µ–∫—Ç—Ä
freqs = fftfreq(N, 1/fs)  # –û—Å–∏ —á–∞—Å—Ç–æ—Ç

# –ù–æ—Ä–º–∏—Ä–æ–≤–∫–∞
S_normalized = np.abs(S) / N

# –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã
freqs_positive = freqs[:N//2]
S_positive = S_normalized[:N//2]

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))

# –ì—Ä–∞—Ñ–∏–∫ —Å–∏–≥–Ω–∞–ª–∞
ax1.plot(t[:100], s[:100], 'b', linewidth=1.5)
ax1.set_title('–ò—Å—Ö–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª (–ø–µ—Ä–≤—ã–µ 100 –æ—Ç—Å—á–µ—Ç–æ–≤)')
ax1.set_xlabel('–í—Ä–µ–º—è, —Å')
ax1.set_ylabel('–ê–º–ø–ª–∏—Ç—É–¥–∞')
ax1.grid(True)

# –°–ø–µ–∫—Ç—Ä
ax2.plot(freqs_positive, S_positive, 'r', linewidth=1.5)
ax2.set_title('–ê–º–ø–ª–∏—Ç—É–¥–Ω—ã–π —Å–ø–µ–∫—Ç—Ä (FFT)')
ax2.set_xlabel('–ß–∞—Å—Ç–æ—Ç–∞, –ì—Ü')
ax2.set_ylabel('–ê–º–ø–ª–∏—Ç—É–¥–∞ (–Ω–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)')
ax2.grid(True)
ax2.set_xlim([0, 100])

plt.tight_layout()
plt.show()

print(f'–ü–∏–∫–∏ —Å–ø–µ–∫—Ç—Ä–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —á–∞—Å—Ç–æ—Ç–∞—Ö: {f1}, {f2}, {f3} –ì—Ü')"""

# ===== –Ø–ß–ï–ô–ö–ê 5: –¢–ï–û–†–ò–Ø –£–¢–ï–ß–ö–ò –°–ü–ï–ö–¢–†–ê =====
md3 = """## 2. –£—Ç–µ—á–∫–∞ —Å–ø–µ–∫—Ç—Ä–∞ (Spectral Leakage)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –¥–ª–∏–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞ –Ω–µ –∫—Ä–∞—Ç–Ω–∞ –ø–µ—Ä–∏–æ–¥—É, —ç–Ω–µ—Ä–≥–∏—è "—Ä–∞–∑–º–∞–∑—ã–≤–∞–µ—Ç—Å—è" –ø–æ —Å–ø–µ–∫—Ç—Ä—É.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ–º **–æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** (windows), –∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞–≤–Ω–æ –æ–±–Ω—É–ª—è—é—Ç –∫—Ä–∞—è —Å–∏–≥–Ω–∞–ª–∞.

–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –æ–∫–Ω–∞:
- **Hamming:** $w[n] = 0.54 - 0.46\\cos(2\\pi n/N)$
- **Hann:** $w[n] = 0.5 - 0.5\\cos(2\\pi n/N)$
- **Blackman:** –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è, –Ω–æ –ª—É—á—à–µ –ø–æ–¥–∞–≤–ª—è–µ—Ç –±–æ–∫–æ–≤—ã–µ –ª–µ–ø–µ—Å—Ç–∫–∏"""

# ===== –Ø–ß–ï–ô–ö–ê 6: –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –£–¢–ï–ß–ö–ò –ò –û–ö–û–ù =====
code_windowing = """# –°–∏–≥–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –∫—Ä–∞—Ç–µ–Ω –ø–µ—Ä–∏–æ–¥—É (–≤—ã–∑—ã–≤–∞–µ—Ç —É—Ç–µ—á–∫—É)
fs = 1000
duration = 0.95  # –ù–ï —Ü–µ–ª–∞—è —Å–µ–∫—É–Ω–¥–∞!
t = np.arange(0, duration, 1/fs)
f = 10  # –ß–∞—Å—Ç–æ—Ç–∞ 10 –ì—Ü (–∏–¥–µ–∞–ª—å–Ω–∞—è)
s_noperiodic = np.sin(2*np.pi*f*t)

# FFT –±–µ–∑ –æ–∫–Ω–∞ –∏ —Å –æ–∫–Ω–∞–º–∏
N = len(s_noperiodic)
freqs = fftfreq(N, 1/fs)[:N//2]

# –ë–µ–∑ –æ–∫–Ω–∞
S_no_window = np.abs(fft(s_noperiodic))[:N//2] / N

# –° –æ–∫–Ω–æ–º Hamming
window_hamming = signal.hamming(N)
s_windowed = s_noperiodic * window_hamming
S_hamming = np.abs(fft(s_windowed))[:N//2] / N

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig, axes = plt.subplots(2, 2, figsize=(12, 8))

# –ò—Å—Ö–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª
axes[0, 0].plot(t, s_noperiodic, 'b')
axes[0, 0].set_title('–ò—Å—Ö–æ–¥–Ω—ã–π —Å–∏–≥–Ω–∞–ª (–Ω–µ –∫—Ä–∞—Ç–µ–Ω –ø–µ—Ä–∏–æ–¥—É)')
axes[0, 0].set_xlabel('–í—Ä–µ–º—è, —Å')
axes[0, 0].grid(True)

# –û–∫–æ–Ω–Ω—ã–π —Å–∏–≥–Ω–∞–ª
axes[0, 1].plot(t, s_windowed, 'g')
axes[0, 1].set_title('–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–∫–Ω–∞ Hamming')
axes[0, 1].set_xlabel('–í—Ä–µ–º—è, —Å')
axes[0, 1].grid(True)

# –°–ø–µ–∫—Ç—Ä –±–µ–∑ –æ–∫–Ω–∞ (—É—Ç–µ—á–∫–∞!)
axes[1, 0].semilogy(freqs, S_no_window)
axes[1, 0].set_title('–°–ø–µ–∫—Ç—Ä –ë–ï–ó –æ–∫–Ω–∞ (–≤–∏–¥–Ω–∞ —É—Ç–µ—á–∫–∞)')
axes[1, 0].set_xlabel('–ß–∞—Å—Ç–æ—Ç–∞, –ì—Ü')
axes[1, 0].set_xlim([0, 50])
axes[1, 0].grid(True)

# –°–ø–µ–∫—Ç—Ä —Å –æ–∫–Ω–æ–º (—á–∏—â–µ)
axes[1, 1].semilogy(freqs, S_hamming)
axes[1, 1].set_title('–°–ø–µ–∫—Ç—Ä –° –æ–∫–Ω–æ–º Hamming (—É—Ç–µ—á–∫–∞ –ø–æ–¥–∞–≤–ª–µ–Ω–∞)')
axes[1, 1].set_xlabel('–ß–∞—Å—Ç–æ—Ç–∞, –ì—Ü')
axes[1, 1].set_xlim([0, 50])
axes[1, 1].grid(True)

plt.tight_layout()
plt.show()"""

# ===== –Ø–ß–ï–ô–ö–ê 7: –ó–ê–î–ê–ù–ò–ï =====
md4 = """## üõ† –ó–ê–î–ê–ù–ò–ï: –°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–≤—É–∫–∞

**–ó–∞–¥–∞—á–∞:** –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª (–∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å) –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ —Å–ø–µ–∫—Ç—Ä.

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
1. –°–æ–∑–¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å audio (—Å–º. –Ω–∏–∂–µ)
2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–∫–Ω–æ Hann
3. –í—ã—á–∏—Å–ª–∏—Ç—å FFT
4. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∞–º–ø–ª–∏—Ç—É–¥–Ω—ã–π —Å–ø–µ–∫—Ç—Ä (–ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞)
5. –ù–∞–π—Ç–∏ 5 –≥–ª–∞–≤–Ω—ã—Ö –ø–∏–∫–æ–≤ –∏ –∏—Ö —á–∞—Å—Ç–æ—Ç—ã"""

# ===== –Ø–ß–ï–ô–ö–ê 8: –†–ï–®–ï–ù–ò–ï =====
code_task = """# –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–≥–æ–ª–æ—Å" –∫–∞–∫ –º–∏–∫—Å —á–∞—Å—Ç–æ—Ç
fs = 8000
t = np.arange(0, 2.0, 1/fs)

# –°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π "–≥–æ–ª–æ—Å": –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ 200 –ì—Ü + –≥–∞—Ä–º–æ–Ω–∏–∫–∏
f0 = 200  # –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞
harmonics = f0 * np.array([1, 2, 3, 4, 5])  # –ì–∞—Ä–º–æ–Ω–∏–∫–∏
amplitudes = np.array([1.0, 0.5, 0.3, 0.2, 0.1])

s_voice = np.zeros_like(t)
for h, amp in zip(harmonics, amplitudes):
    s_voice += amp * np.sin(2*np.pi*h*t)

# –î–æ–±–∞–≤–∏–º —à—É–º
s_voice += 0.05 * np.random.randn(len(t))

# –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–∫–Ω–æ Hann
window = signal.hann(len(s_voice))
s_windowed = s_voice * window

# FFT
N = len(s_windowed)
S = np.abs(fft(s_windowed)) / N
freqs = fftfreq(N, 1/fs)[:N//2]
S = S[:N//2]

# –ù–∞—Ö–æ–¥–∏–º —Ç–æ–ø-5 –ø–∏–∫–æ–≤
top_indices = np.argsort(S)[-5:][::-1]
top_freqs = freqs[top_indices]
top_amps = S[top_indices]

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8))

# –í–æ–ª–Ω–∞
ax1.plot(t[:1000], s_voice[:1000], 'b', linewidth=0.5, label='–°–∏–≥–Ω–∞–ª')
ax1.plot(t[:1000], window[:1000], 'r--', linewidth=1, label='–û–∫–Ω–æ Hann')
ax1.set_title('–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π "–≥–æ–ª–æ—Å" —Å –æ–∫–Ω–æ–º')
ax1.set_xlabel('–í—Ä–µ–º—è, —Å')
ax1.set_ylabel('–ê–º–ø–ª–∏—Ç—É–¥–∞')
ax1.legend()
ax1.grid(True)

# –°–ø–µ–∫—Ç—Ä (–ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞)
ax2.semilogy(freqs, S, 'g', linewidth=1)
ax2.scatter(top_freqs, top_amps, color='r', s=100, zorder=5, label='–¢–æ–ø-5 –ø–∏–∫–æ–≤')
ax2.set_title('–°–ø–µ–∫—Ç—Ä "–≥–æ–ª–æ—Å–∞" (–ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞)')
ax2.set_xlabel('–ß–∞—Å—Ç–æ—Ç–∞, –ì—Ü')
ax2.set_ylabel('–ê–º–ø–ª–∏—Ç—É–¥–∞')
ax2.set_xlim([0, 1000])
ax2.grid(True, which='both', alpha=0.3)
ax2.legend()

plt.tight_layout()
plt.show()

# –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
print("\\n=== –¢–û–ü-5 –ü–ò–ö–û–í –°–ü–ï–ö–¢–†–ê ===")
for i, (f, amp) in enumerate(zip(top_freqs, top_amps), 1):
    print(f"{i}. –ß–∞—Å—Ç–æ—Ç–∞: {f:.1f} –ì—Ü, –ê–º–ø–ª–∏—Ç—É–¥–∞: {amp:.4f}")"""

# ===== –°–ë–û–†–ö–ê –ù–û–£–¢–ë–£–ö–ê =====
nb['cells'] = [
    nbf.v4.new_markdown_cell(md1),
    nbf.v4.new_code_cell(code_imports),
    nbf.v4.new_markdown_cell(md2),
    nbf.v4.new_code_cell(code_basic),
    nbf.v4.new_markdown_cell(md3),
    nbf.v4.new_code_cell(code_windowing),
    nbf.v4.new_markdown_cell(md4),
    nbf.v4.new_code_cell(code_task)
]

# –°–æ—Ö—Ä–∞–Ω—è–µ–º
os.makedirs('notebooks/Lab2_Spectral', exist_ok=True)
with open('notebooks/Lab2_Spectral/Lab2_FFT.ipynb', 'w', encoding='utf-8') as f:
    nbf.write(nb, f)

print("‚úÖ Lab2_FFT.ipynb —Å–æ–∑–¥–∞–Ω!")
