import nbformat as nbf
import os

nb = nbf.v4.new_notebook()

# ===== 1. –ó–ê–ì–û–õ–û–í–û–ö =====
md1 = """# üéõÔ∏è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ3: –õ–∏–Ω–µ–π–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –∏ —Å–≤—ë—Ä—Ç–∫–∞
**–ö—É—Ä—Å:** –û—Å–Ω–æ–≤—ã —Ç–µ–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ —Å–∏—Å—Ç–µ–º (–û–¢–°–∏–°)  
**–¶–µ–ª—å:** –ò–∑—É—á–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é –ª–∏–Ω–µ–π–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –Ω–∞ –≤—Ö–æ–¥–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏—é —Å–≤—ë—Ä—Ç–∫–∏.

## üéØ –ö–ª—é—á–µ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
1. –ß—Ç–æ —Ç–∞–∫–æ–µ LTI-—Å–∏—Å—Ç–µ–º–∞ (Linear Time-Invariant)?
2. –ß—Ç–æ —Ç–∞–∫–æ–µ –∏–º–ø—É–ª—å—Å–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ $h[n]$?
3. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–≤—ë—Ä—Ç–∫–∞ (Convolution)?
4. –ö–∞–∫ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª, –∑–Ω–∞—è $h[n]$?"""

# ===== 2. –ò–ú–ü–û–†–¢–´ =====
code_imports = """import numpy as np
import matplotlib.pyplot as plt
from scipy import signal

plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (12, 6)
print('‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥–æ—Ç–æ–≤—ã!')"""

# ===== 3. –¢–ï–û–†–ò–Ø: –°–í–Å–†–¢–ö–ê =====
md2 = """## 1. –°–≤—ë—Ä—Ç–∫–∞ (Convolution)

–í—ã—Ö–æ–¥ LTI-—Å–∏—Å—Ç–µ–º—ã $y[n]$ ‚Äî —ç—Ç–æ —Å–≤—ë—Ä—Ç–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ $x[n]$ –∏ –∏–º–ø—É–ª—å—Å–Ω–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ $h[n]$:

$$ y[n] = x[n] * h[n] = \\sum_{k=-\\infty}^{\\infty} x[k] h[n-k] $$

**–ò–Ω—Ç—É–∏—Ü–∏—è:** –ú—ã "–ø—Ä–æ—Ç–∞—Å–∫–∏–≤–∞–µ–º" –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—É—é –∏–º–ø—É–ª—å—Å–Ω—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª."""

# ===== 4. –ü–†–ò–ú–ï–† –°–í–Å–†–¢–ö–ò =====
code_conv = """# –í—Ö–æ–¥–Ω–æ–π —Å–∏–≥–Ω–∞–ª: –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã–π –∏–º–ø—É–ª—å—Å
x = np.array([0, 0, 1, 1, 1, 1, 0, 0])

# –ò–º–ø—É–ª—å—Å–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞: —Å–≥–ª–∞–∂–∏–≤–∞—é—â–∏–π —Ñ–∏–ª—å—Ç—Ä (Moving Average)
h = np.array([0.33, 0.33, 0.33])

# –í—ã—á–∏—Å–ª—è–µ–º —Å–≤—ë—Ä—Ç–∫—É
y = signal.convolve(x, h, mode='full')

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(8, 10))

ax1.stem(x)
ax1.set_title('–í—Ö–æ–¥ x[n]')
ax1.set_ylim([0, 1.2])

ax2.stem(h)
ax2.set_title('–ò–º–ø—É–ª—å—Å–Ω–∞—è —Ö–∞—Ä-–∫–∞ h[n]')
ax2.set_xlim([0, len(x)])

ax3.stem(y)
ax3.set_title('–í—ã—Ö–æ–¥ y[n] (–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–≤—ë—Ä—Ç–∫–∏)')
ax3.set_xlabel('–û—Ç—Å—á–µ—Ç—ã')

plt.tight_layout()
plt.show()

print(f"–î–ª–∏–Ω–∞ –≤—Ö–æ–¥–∞: {len(x)}")
print(f"–î–ª–∏–Ω–∞ —è–¥—Ä–∞: {len(h)}")
print(f"–î–ª–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞: {len(y)} (L_x + L_h - 1)")"""

# ===== 5. –¢–ï–û–†–ò–Ø: –ò–ú–ü–£–õ–¨–°–ù–ê–Ø –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ê =====
md3 = """## 2. –ò–º–ø—É–ª—å—Å–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ (Impulse Response)

–≠—Ç–æ —Ä–µ–∞–∫—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –µ–¥–∏–Ω–∏—á–Ω—ã–π –∏–º–ø—É–ª—å—Å (—É–¥–∞—Ä). –ó–Ω–∞—è $h[n]$, –º—ã –∑–Ω–∞–µ–º –æ —Å–∏—Å—Ç–µ–º–µ –í–°–Å.

–ü—Ä–∏–º–µ—Ä—ã —Å–∏—Å—Ç–µ–º:
1. **–≠—Ö–æ:** $h = [1, 0, 0, 0.5]$ (—Å–∏–≥–Ω–∞–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —Å –∑–∞—Ç—É—Ö–∞–Ω–∏–µ–º)
2. **–ù–∏–∑–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (Low Pass):** $h = [0.1, 0.1, ..., 0.1]$ (—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ)
3. **–í—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä (High Pass):** $h = [1, -1]$ (–≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∞–¥–æ–≤)"""

# ===== 6. –ê–£–î–ò–û –≠–§–§–ï–ö–¢–´ (–≠–•–û) =====
code_audio = """# –°–æ–∑–¥–∞–¥–∏–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–≤—É–∫ (—â–µ–ª—á–æ–∫)
fs = 8000
t = np.arange(0, 0.5, 1/fs)
x_sound = np.zeros_like(t)
x_sound[100:200] = 1  # –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫

# –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –≠–•–û
# h = [1, 0, ..., 0, 0.6, 0, ..., 0, 0.3]
delay_samples = int(0.1 * fs) # 100 –º—Å –∑–∞–¥–µ—Ä–∂–∫–∞
h_echo = np.zeros(delay_samples * 2 + 1)
h_echo[0] = 1.0           # –ü—Ä—è–º–æ–π –∑–≤—É–∫
h_echo[delay_samples] = 0.6 # –ü–µ—Ä–≤–æ–µ —ç—Ö–æ
h_echo[delay_samples*2] = 0.3 # –í—Ç–æ—Ä–æ–µ —ç—Ö–æ

# –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç
y_echo = signal.convolve(x_sound, h_echo, mode='full')

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
fig, (ax1, ax2) = plt.subplots(2, 1, sharex=True)
ax1.plot(t, x_sound)
ax1.set_title('–ò—Å—Ö–æ–¥–Ω—ã–π –∑–≤—É–∫')
ax1.grid(True)

# –û—Å—å –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≤—ã—Ö–æ–¥–∞ –¥–ª–∏–Ω–Ω–µ–µ
t_out = np.arange(0, len(y_echo)) / fs
ax2.plot(t_out, y_echo, 'g')
ax2.set_title('–ó–≤—É–∫ —Å —ç—Ö–æ–º')
ax2.set_xlabel('–í—Ä–µ–º—è, —Å')
ax2.grid(True)

plt.show()"""

# ===== 7. –ó–ê–î–ê–ù–ò–ï =====
md4 = """## üõ† –ó–ê–î–ê–ù–ò–ï: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞—à—É–º–ª–µ–Ω–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞

**–î–∞–Ω–æ:** –°–∏–Ω—É—Å–æ–∏–¥–∞ —Å —Å–∏–ª—å–Ω—ã–º —à—É–º–æ–º.
**–ó–∞–¥–∞—á–∞:** –û—á–∏—Å—Ç–∏—Ç—å —Å–∏–≥–Ω–∞–ª, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–∏–ª—å—Ç—Ä "–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ" (Moving Average).

1. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–∏–≥–Ω–∞–ª: $x(t) = \sin(2\pi \cdot 5 \cdot t) + \text{—à—É–º}$
2. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä $h$: –º–∞—Å—Å–∏–≤ –∏–∑ 50 —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —Ä–∞–≤–Ω—ã—Ö $1/50$.
3. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ —Å–≤—ë—Ä—Ç–∫—É `signal.convolve`.
4. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞ –æ–¥–Ω–æ–º –≥—Ä–∞—Ñ–∏–∫–µ: –∏—Å—Ö–æ–¥–Ω—ã–π (—Å–µ—Ä—ã–º) –∏ –æ—á–∏—â–µ–Ω–Ω—ã–π (–∫—Ä–∞—Å–Ω—ã–º)."""

# ===== 8. –†–ï–®–ï–ù–ò–ï =====
code_task = """# 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
fs = 1000
t = np.arange(0, 2.0, 1/fs)
s_pure = np.sin(2*np.pi*5*t)
noise = 0.5 * np.random.randn(len(t))
x_noisy = s_pure + noise

# 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ (Moving Average)
# –£—Å—Ä–µ–¥–Ω—è–µ–º –ø–æ 50 —Ç–æ—á–∫–∞–º (50 –º—Å)
M = 50
h_ma = np.ones(M) / M

# 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
# mode='same' —á—Ç–æ–±—ã –¥–ª–∏–Ω–∞ –≤—ã—Ö–æ–¥–∞ —Å–æ–≤–ø–∞–¥–∞–ª–∞ —Å –≤—Ö–æ–¥–æ–º
y_filtered = signal.convolve(x_noisy, h_ma, mode='same')

# 4. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
plt.figure(figsize=(12, 6))
plt.plot(t, x_noisy, 'gray', alpha=0.5, label='–ó–∞—à—É–º–ª–µ–Ω–Ω—ã–π')
plt.plot(t, y_filtered, 'r', linewidth=2, label='–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π (MA-50)')
plt.plot(t, s_pure, 'b--', linewidth=1, label='–ò–¥–µ–∞–ª')
plt.title('–ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ —à—É–º–∞ –º–µ—Ç–æ–¥–æ–º —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ')
plt.legend()
plt.grid(True)
plt.show()"""

# ===== –°–ë–û–†–ö–ê =====
nb['cells'] = [
    nbf.v4.new_markdown_cell(md1),
    nbf.v4.new_code_cell(code_imports),
    nbf.v4.new_markdown_cell(md2),
    nbf.v4.new_code_cell(code_conv),
    nbf.v4.new_markdown_cell(md3),
    nbf.v4.new_code_cell(code_audio),
    nbf.v4.new_markdown_cell(md4),
    nbf.v4.new_code_cell(code_task)
]

os.makedirs('notebooks/Lab3_Systems', exist_ok=True)
with open('notebooks/Lab3_Systems/Lab3_Convolution.ipynb', 'w', encoding='utf-8') as f:
    nbf.write(nb, f)

print("‚úÖ Lab3_Convolution.ipynb —Å–æ–∑–¥–∞–Ω!")
